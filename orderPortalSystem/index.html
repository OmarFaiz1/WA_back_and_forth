<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Orders Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      let currentFilter = "all";
      let currentDeliveryTime = null;
      const socket = io();
      socket.on("orders_update", (data) => {
        console.log("Real-time update received", data);
        fetchOrders(currentFilter, currentDeliveryTime);
      });

      function showNotification(message) {
        const notif = document.getElementById("notification");
        notif.innerText = message;
        notif.classList.remove("hidden");
        setTimeout(() => {
          notif.classList.add("hidden");
        }, 5000);
      }

      function toggleNavbar() {
        const menu = document.getElementById("navbar-menu");
        menu.classList.toggle("hidden");
      }

      async function fetchOrders(filter = "all", deliveryTime = null) {
        currentFilter = filter;
        currentDeliveryTime = deliveryTime;
        updateNavbarActive();
        try {
          let url = "/api/orders?filter=" + filter;
          if (deliveryTime && !isNaN(deliveryTime)) {
            url += "&deliveryTime=" + deliveryTime;
          }
          const res = await fetch(url);
          const data = await res.json();
          if (data.error) {
            console.error("Error fetching orders:", data.error);
            return;
          }
          populateTable(data.orders);
        } catch (error) {
          console.error("Error fetching orders:", error);
        }
      }

      function populateTable(orders) {
        const tbody = document.getElementById("orders-tbody");
        tbody.innerHTML = "";
        orders.forEach((order) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td class="border px-4 py-2">${order.order_ref_number}</td>
          <td class="border px-4 py-2">${order.customer_name}</td>
          <td class="border px-4 py-2">PKR ${order.amount}</td>
          <td class="border px-4 py-2">${order.status}</td>
          <td class="border px-4 py-2">${order.delivery_time}</td>
          <td class="border px-4 py-2">
            <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 m-1 rounded transition duration-200" onclick="showDetails('${order.order_ref_number}')">Show All</button>
            <button class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 m-1 rounded transition duration-200" onclick="openUpdateStatus('${order.order_ref_number}', '${order.status}')">Update Status</button>
            <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 m-1 rounded transition duration-200" onclick="openUpdateDelivery('${order.order_ref_number}', ${order.delivery_time})">Update Delivery</button>
          </td>
        `;
          tbody.appendChild(tr);
        });
      }

      async function showDetails(order_ref_number) {
        try {
          const res = await fetch("/api/order/" + order_ref_number);
          const data = await res.json();
          const order = data.order;
          document.getElementById("detailContent").innerHTML = `
          <p><strong>Customer:</strong> ${order.customer_name}</p>
          <p><strong>Phone:</strong> ${order.phone || "N/A"}</p>
          <p><strong>Total:</strong> PKR ${order.amount}</p>
          <p><strong>City:</strong> ${order.city || "N/A"}</p>
        `;
          openModal("detailModal");
        } catch (error) {
          console.error("Error fetching order details:", error);
        }
      }

      let currentOrderForStatus = null;
      function openUpdateStatus(order_ref_number, currentStatus) {
        currentOrderForStatus = order_ref_number;
        document.getElementById("statusSelect").value = currentStatus;
        openModal("statusModal");
      }

      async function submitStatusUpdate() {
        const newStatus = document.getElementById("statusSelect").value;
        if (newStatus === "no") {
          openModal("cancellationReasonModal");
        } else {
          try {
            const res = await fetch(
              "/api/order/" + currentOrderForStatus + "/update-status",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus }),
              }
            );
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            showNotification(`Status updated to ${newStatus}`);
            closeModal("statusModal");
            fetchOrders(currentFilter, currentDeliveryTime);
          } catch (error) {
            console.error("Error updating status:", error);
            showNotification("Error updating status: " + error.message);
          }
        }
      }

      async function submitCancellationReason() {
        const reasonSelect = document.getElementById(
          "cancellationReasonSelect"
        ).value;
        const customReason = document
          .getElementById("customCancellationReason")
          .value.trim();
        const reason = reasonSelect === "custom" ? customReason : reasonSelect;
        if (!reason) {
          showNotification("Please select or enter a cancellation reason.");
          return;
        }
        document.getElementById("confirmCancellationReasonText").innerText =
          reason;
        closeModal("cancellationReasonModal");
        openModal("confirmCancellationModal");
        document.getElementById("confirmCancellationButton").onclick =
          async () => {
            try {
              const res = await fetch(
                "/api/order/" + currentOrderForStatus + "/update-status",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    status: "no",
                    cancellationReason: reason,
                  }),
                }
              );
              const data = await res.json();
              if (data.error) throw new Error(data.error);
              showNotification("Status updated to no and message sent.");
              closeModal("confirmCancellationModal");
              closeModal("statusModal");
              fetchOrders(currentFilter, currentDeliveryTime);
            } catch (error) {
              console.error("Error updating status:", error);
              showNotification("Error updating status: " + error.message);
            }
          };
      }

      let currentOrderForDelivery = null;
      function openUpdateDelivery(order_ref_number, currentDelivery) {
        currentOrderForDelivery = order_ref_number;
        document.getElementById("deliveryInput").value = currentDelivery;
        openModal("deliveryModal");
      }

      async function submitDeliveryUpdate() {
        const newDelivery = parseInt(
          document.getElementById("deliveryInput").value
        );
        if (isNaN(newDelivery) || newDelivery < 0) {
          showNotification("Please enter a valid delivery time.");
          return;
        }
        openModal("delayReasonModal");
      }

      async function submitDelayReason() {
        const reasonSelect = document.getElementById("delayReasonSelect").value;
        const customReason = document
          .getElementById("customDelayReason")
          .value.trim();
        const reason = reasonSelect === "custom" ? customReason : reasonSelect;
        if (!reason) {
          showNotification("Please select or enter a delay reason.");
          return;
        }
        const newDelivery = parseInt(
          document.getElementById("deliveryInput").value
        );
        document.getElementById("confirmDelayReasonText").innerText = reason;
        closeModal("delayReasonModal");
        openModal("confirmDelayModal");
        document.getElementById("confirmDelayButton").onclick = async () => {
          try {
            const res = await fetch(
              "/api/order/" + currentOrderForDelivery + "/update-delivery",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  delivery_time: newDelivery,
                  delayReason: reason,
                }),
              }
            );
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            showNotification(
              `Delivery time updated to ${newDelivery} and message sent.`
            );
            closeModal("confirmDelayModal");
            closeModal("deliveryModal");
            fetchOrders(currentFilter, currentDeliveryTime);
          } catch (error) {
            console.error("Error updating delivery:", error);
            showNotification("Error updating delivery: " + error.message);
          }
        };
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.remove("hidden");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
      }
      window.onclick = function (event) {
        const modals = document.getElementsByClassName("modal");
        for (let modal of modals) {
          if (!modal.classList.contains("hidden") && event.target === modal) {
            modal.classList.add("hidden");
          }
        }
      };

      function setFilter(filter) {
        currentFilter = filter;
        currentDeliveryTime = null;
        document.getElementById("deliveryFilter").value = "all";
        fetchOrders(filter);
      }

      function setDeliveryFilter() {
        const deliveryTime = document.getElementById("deliveryFilter").value;
        if (deliveryTime === "all") {
          currentDeliveryTime = null;
          fetchOrders(currentFilter);
        } else if (
          !isNaN(deliveryTime) &&
          deliveryTime >= 1 &&
          deliveryTime <= 10
        ) {
          currentDeliveryTime = parseInt(deliveryTime);
          fetchOrders("all", currentDeliveryTime);
        } else {
          showNotification("Please enter a valid delivery time (1-10).");
        }
      }

      function updateNavbarActive() {
        const links = document.getElementsByClassName("nav-link");
        for (let link of links) {
          if (link.getAttribute("data-filter") === currentFilter) {
            link.classList.add("bg-blue-700", "text-white", "shadow-md");
            link.classList.remove("bg-transparent", "text-blue-500");
          } else {
            link.classList.remove("bg-blue-700", "text-white", "shadow-md");
            link.classList.add("bg-transparent", "text-blue-500");
          }
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        fetchOrders();
      });
    </script>
  </head>
  <body class="bg-gray-100">
    <div
      id="notification"
      class="fixed top-4 left-4 bg-green-500 text-white px-4 py-2 rounded shadow hidden"
    ></div>
    <header class="bg-gray-900 text-white shadow-lg">
      <div
        class="container mx-auto px-4 flex items-center justify-between py-4"
      >
        <div class="flex items-center space-x-4">
          <h1 class="text-4xl font-extrabold">Orders Portal</h1>
          <div>
            <label for="deliveryFilter" class="mr-2">Delivery Time:</label>
            <select
              id="deliveryFilter"
              onchange="setDeliveryFilter()"
              class="border p-2 rounded text-black"
            >
              <option value="all">All</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
          </div>
        </div>
        <nav class="hidden md:block">
          <ul class="flex space-x-4">
            <li>
              <a
                href="#"
                data-filter="all"
                class="nav-link block py-2 px-4 rounded transition-colors duration-200 hover:bg-blue-600 hover:text-white"
                onclick="setFilter('all')"
                >All Orders</a
              >
            </li>
            <li>
              <a
                href="#"
                data-filter="pending"
                class="nav-link block py-2 px-4 rounded transition-colors duration-200 hover:bg-blue-600 hover:text-white"
                onclick="setFilter('pending')"
                >Pending Orders</a
              >
            </li>
            <li>
              <a
                href="#"
                data-filter="completed"
                class="nav-link block py-2 px-4 rounded transition-colors duration-200 hover:bg-blue-600 hover:text-white"
                onclick="setFilter('completed')"
                >Completed Orders</a
              >
            </li>
            <li>
              <a
                href="#"
                data-filter="rejected"
                class="nav-link block py-2 px-4 rounded transition-colors duration-200 hover:bg-blue-600 hover:text-white"
                onclick="setFilter('rejected')"
                >Rejected Orders</a
              >
            </li>
          </ul>
        </nav>
        <button
          id="hamburger"
          class="md:hidden text-white focus:outline-none"
          onclick="toggleNavbar()"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            ></path>
          </svg>
        </button>
      </div>
      <nav class="md:hidden bg-gray-800">
        <ul id="navbar-menu" class="flex flex-col space-y-1 px-4 pb-4 hidden">
          <li>
            <a
              href="#"
              data-filter="all"
              class="nav-link block py-2 px-4 rounded transition-colors duration-200 hover:bg-blue-600 hover:text-white"
              onclick="setFilter('all'); toggleNavbar()"
              >All Orders</a
            >
          </li>
          <li>
            <a
              href="#"
              data-filter="pending"
              class="nav-link block py-2 px-4 rounded transition-colors duration-200 hover:bg-blue-600 hover:text-white"
              onclick="setFilter('pending'); toggleNavbar()"
              >Pending Orders</a
            >
          </li>
          <li>
            <a
              href="#"
              data-filter="completed"
              class="nav-link block py-2 px-4 rounded transition-colors duration-200 hover:bg-blue-600 hover:text-white"
              onclick="setFilter('completed'); toggleNavbar()"
              >Completed Orders</a
            >
          </li>
          <li>
            <a
              href="#"
              data-filter="rejected"
              class="nav-link block py-2 px-4 rounded transition-colors duration-200 hover:bg-blue-600 hover:text-white"
              onclick="setFilter('rejected'); toggleNavbar()"
              >Rejected Orders</a
            >
          </li>
        </ul>
      </nav>
    </header>
    <div class="container mx-auto px-4 mt-6">
      <table class="min-w-full bg-white shadow rounded">
        <thead>
          <tr>
            <th class="py-2 px-4 border">Order Ref</th>
            <th class="py-2 px-4 border">Name</th>
            <th class="py-2 px-4 border">Total</th>
            <th class="py-2 px-4 border">Status</th>
            <th class="py-2 px-4 border">Delivery</th>
            <th class="py-2 px-4 border">Actions</th>
          </tr>
        </thead>
        <tbody id="orders-tbody"></tbody>
      </table>
    </div>
    <div
      id="detailModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-6 rounded shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Order Details</h2>
        <div id="detailContent"></div>
        <button
          onclick="closeModal('detailModal')"
          class="mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
        >
          Close
        </button>
      </div>
    </div>
    <div
      id="statusModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-6 rounded shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Update Status</h2>
        <select id="statusSelect" class="border p-2 mb-4 w-full">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
        <div class="flex justify-end">
          <button
            onclick="submitStatusUpdate()"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2"
          >
            Update
          </button>
          <button
            onclick="closeModal('statusModal')"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div
      id="cancellationReasonModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-6 rounded shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Reason for Cancellation</h2>
        <select id="cancellationReasonSelect" class="border p-2 mb-4 w-full">
          <option value="Customer Request">Customer Request</option>
          <option value="Out of Stock">Out of Stock</option>
          <option value="Payment Issue">Payment Issue</option>
          <option value="custom">Custom Reason</option>
        </select>
        <textarea
          id="customCancellationReason"
          class="border p-2 mb-4 w-full hidden"
          placeholder="Enter custom reason"
        ></textarea>
        <div class="flex justify-end">
          <button
            onclick="submitCancellationReason()"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2"
          >
            OK
          </button>
          <button
            onclick="closeModal('cancellationReasonModal')"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div
      id="confirmCancellationModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-6 rounded shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Confirm Cancellation</h2>
        <p>
          Are you sure you want to cancel this order with the following reason?
        </p>
        <p class="my-4">
          <strong>Reason:</strong>
          <span id="confirmCancellationReasonText"></span>
        </p>
        <div class="flex justify-end">
          <button
            id="confirmCancellationButton"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2"
          >
            OK
          </button>
          <button
            onclick="closeModal('confirmCancellationModal')"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div
      id="deliveryModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-6 rounded shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Update Delivery Time</h2>
        <input
          type="number"
          id="deliveryInput"
          class="border p-2 mb-4 w-full"
          min="0"
          placeholder="Enter delivery days"
        />
        <div class="flex justify-end">
          <button
            onclick="submitDeliveryUpdate()"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2"
          >
            Update
          </button>
          <button
            onclick="closeModal('deliveryModal')"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div
      id="delayReasonModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-6 rounded shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Reason for Delay</h2>
        <select
          id="delayReasonSelect"
          class="border p-2 mb-4 w-full"
          onchange="toggleCustomDelayReason()"
        >
          <option value="Production Delay">Production Delay</option>
          <option value="Shipping Issue">Shipping Issue</option>
          <option value="Inventory Shortage">Inventory Shortage</option>
          <option value="custom">Custom Reason</option>
        </select>
        <textarea
          id="customDelayReason"
          class="border p-2 mb-4 w-full hidden"
          placeholder="Enter custom reason"
        ></textarea>
        <div class="flex justify-end">
          <button
            onclick="submitDelayReason()"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2"
          >
            OK
          </button>
          <button
            onclick="closeModal('delayReasonModal')"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div
      id="confirmDelayModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-6 rounded shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Confirm Delay</h2>
        <p>
          Are you sure you want to update the delivery time with the following
          reason?
        </p>
        <p class="my-4">
          <strong>Reason:</strong> <span id="confirmDelayReasonText"></span>
        </p>
        <div class="flex justify-end">
          <button
            id="confirmDelayButton"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2"
          >
            OK
          </button>
          <button
            onclick="closeModal('confirmDelayModal')"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
    <script>
      function toggleCustomDelayReason() {
        const select = document.getElementById("delayReasonSelect");
        const textarea = document.getElementById("customDelayReason");
        textarea.classList.toggle("hidden", select.value !== "custom");
      }
      function toggleCustomCancellationReason() {
        const select = document.getElementById("cancellationReasonSelect");
        const textarea = document.getElementById("customCancellationReason");
        textarea.classList.toggle("hidden", select.value !== "custom");
      }
      document
        .getElementById("cancellationReasonSelect")
        .addEventListener("change", toggleCustomCancellationReason);
    </script>
  </body>
</html>
